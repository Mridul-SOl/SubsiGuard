"use client";

import { useState } from "react";
import { useParams } from "next/navigation";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import {
    Download,
    AlertTriangle,
    Share2,
    Printer,
    ChevronLeft
} from "lucide-react";
import Link from "next/link";
import jsPDF from "jspdf";
import autoTable from "jspdf-autotable";
import confetti from "canvas-confetti";

export default function CaseResultPage() {
    const params = useParams();
    const id = params.id as string;
    const [isGenerating, setIsGenerating] = useState(false);

    // Mock data for the specific case
    const caseData = {
        id: id,
        beneficiary: "Ramesh Kumar",
        aadhaar: "XXXX-XXXX-1234",
        scheme: "PM-KISAN",
        status: "Flagged",
        riskScore: 88,
        amount: 6000,
        timestamp: "2024-02-14 10:30 AM",
        anomalies: [
            "Duplicate beneficiary detected in adjacent district",
            "Land record mismatch with registered Aadhaar",
            "Transaction velocity exceeds normal threshold"
        ],
        location: "Lucknow, Uttar Pradesh"
    };

    const generatePDF = () => {
        setIsGenerating(true);

        // Trigger confetti
        confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 },
            colors: ['#002b5c', '#10b981', '#f47321'] // Gov Theme Colors
        });

        const doc = new jsPDF();

        // Header
        doc.setFillColor(0, 43, 92); // Navy
        doc.rect(0, 0, 210, 40, "F");
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(22);
        doc.text("SubsiGuard Audit Report", 14, 25);
        doc.setFontSize(10);
        doc.text("Government of India | Official Document", 14, 32);

        // Case Details
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(12);
        doc.text(`Case ID: ${caseData.id}`, 14, 50);
        doc.text(`Beneficiary: ${caseData.beneficiary}`, 14, 58);
        doc.text(`Status: ${caseData.status}`, 14, 66);
        doc.text(`Risk Score: ${caseData.riskScore}/100`, 14, 74);

        // Anomalies Table
        autoTable(doc, {
            startY: 85,
            head: [['#', 'Detected Anomaly', 'Severity']],
            body: caseData.anomalies.map((anomaly, index) => [index + 1, anomaly, "High"]),
            theme: 'grid',
            headStyles: { fillColor: [0, 43, 92] }
        });

        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        const finalY: any = (doc as any).lastAutoTable.finalY || 150;

        // Footer
        doc.setFontSize(10);
        doc.text("Generated by SubsiGuard AI Fraud Detection System", 14, finalY + 20);
        doc.text(`Date: ${new Date().toLocaleDateString()}`, 14, finalY + 26);

        doc.save(`SubsiGuard_Audit_${id}.pdf`);
        setIsGenerating(false);
    };

    return (
        <div className="container mx-auto px-4 py-8 max-w-5xl">
            <Link href="/dashboard" className="text-slate-500 hover:text-gov-navy flex items-center gap-2 mb-6">
                <ChevronLeft className="w-4 h-4" />
                Back to Dashboard
            </Link>

            <div className="flex flex-col md:flex-row justify-between items-start gap-4 mb-8">
                <div>
                    <div className="flex items-center gap-3 mb-2">
                        <h1 className="text-3xl font-bold text-gov-navy">Audit Report: {id}</h1>
                        <Badge className="bg-red-100 text-red-700 hover:bg-red-200 border-red-200">
                            {caseData.status}
                        </Badge>
                    </div>
                    <p className="text-slate-600">Generated on {caseData.timestamp}</p>
                </div>
                <div className="flex gap-3">
                    <Button variant="outline" className="border-gov-navy text-gov-navy">
                        <Share2 className="w-4 h-4 mr-2" />
                        Share
                    </Button>
                    <Button
                        onClick={generatePDF}
                        disabled={isGenerating}
                        className="bg-gov-navy hover:bg-gov-navy/90 text-white"
                    >
                        {isGenerating ? "Generating..." : (
                            <>
                                <Download className="w-4 h-4 mr-2" />
                                Download Official PDF
                            </>
                        )}
                    </Button>
                </div>
            </div>

            <div className="grid md:grid-cols-3 gap-8">
                {/* Main Details */}
                <div className="md:col-span-2 space-y-6">
                    <Card className="border-l-4 border-l-red-500 shadow-sm">
                        <CardHeader className="bg-red-50/50 pb-4">
                            <CardTitle className="text-lg text-red-700 flex items-center gap-2">
                                <AlertTriangle className="w-5 h-5" />
                                Risk Assessment: Critical
                            </CardTitle>
                        </CardHeader>
                        <CardContent className="pt-6">
                            <div className="flex items-center gap-6 mb-6">
                                <div className="w-32 h-32 relative flex items-center justify-center">
                                    <svg className="w-full h-full transform -rotate-90">
                                        <circle cx="64" cy="64" r="56" stroke="currentColor" strokeWidth="8" fill="transparent" className="text-slate-100" />
                                        <circle cx="64" cy="64" r="56" stroke="currentColor" strokeWidth="8" fill="transparent" strokeDasharray={351.86} strokeDashoffset={351.86 - (351.86 * caseData.riskScore) / 100} className="text-red-500" />
                                    </svg>
                                    <span className="absolute text-3xl font-bold text-gov-navy">{caseData.riskScore}</span>
                                </div>
                                <div>
                                    <h3 className="font-bold text-gov-navy text-lg">High Probability of Leakage</h3>
                                    <p className="text-slate-600">The beneficiary details show multiple inconsistencies indicating potential fraud.</p>
                                </div>
                            </div>

                            <h4 className="font-semibold text-gov-navy mb-3">Detected Anomalies</h4>
                            <ul className="space-y-3">
                                {caseData.anomalies.map((anomaly, idx) => (
                                    <li key={idx} className="flex items-start gap-3 bg-white p-3 rounded border border-slate-100 shadow-sm">
                                        <AlertTriangle className="w-5 h-5 text-red-500 mt-0.5 shrink-0" />
                                        <span className="text-slate-700">{anomaly}</span>
                                    </li>
                                ))}
                            </ul>
                        </CardContent>
                    </Card>

                    <Card className="shadow-sm border-slate-200">
                        <CardHeader>
                            <CardTitle className="text-lg text-gov-navy mb-2">Beneficiary Details</CardTitle>
                        </CardHeader>
                        <CardContent>
                            <dl className="grid grid-cols-2 gap-x-4 gap-y-6">
                                <div>
                                    <dt className="text-sm font-medium text-slate-500">Full Name</dt>
                                    <dd className="text-base font-semibold text-slate-900">{caseData.beneficiary}</dd>
                                </div>
                                <div>
                                    <dt className="text-sm font-medium text-slate-500">Aadhaar (Masked)</dt>
                                    <dd className="text-base font-mono text-slate-900">{caseData.aadhaar}</dd>
                                </div>
                                <div>
                                    <dt className="text-sm font-medium text-slate-500">Scheme</dt>
                                    <dd className="text-base font-semibold text-slate-900">{caseData.scheme}</dd>
                                </div>
                                <div>
                                    <dt className="text-sm font-medium text-slate-500">Claim Amount</dt>
                                    <dd className="text-base font-semibold text-slate-900">â‚¹{caseData.amount}</dd>
                                </div>
                                <div className="col-span-2">
                                    <dt className="text-sm font-medium text-slate-500">Registered Location</dt>
                                    <dd className="text-base text-slate-900">{caseData.location}</dd>
                                </div>
                            </dl>
                        </CardContent>
                    </Card>
                </div>

                {/* Sidebar Actions */}
                <div className="space-y-6">
                    <Card className="bg-gov-navy text-white shadow-lg">
                        <CardHeader>
                            <CardTitle className="text-white">Action Required</CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-4">
                            <p className="text-white/80 text-sm">This case has been marked for manual verification by the field officer.</p>
                            <Button className="w-full bg-white text-gov-navy hover:bg-slate-100 font-bold">
                                Mark as Verified
                            </Button>
                            <Button className="w-full bg-transparent border border-white/30 text-white hover:bg-white/10 font-medium">
                                Dismiss Alert
                            </Button>
                        </CardContent>
                    </Card>

                    <div className="bg-slate-50 rounded-xl p-6 border border-slate-200 text-sm text-slate-500 text-center">
                        <Printer className="w-8 h-8 mx-auto mb-3 text-slate-400" />
                        <p>Need a hard copy?</p>
                        <button onClick={() => window.print()} className="text-gov-navy font-semibold hover:underline mt-1">Print Report</button>
                    </div>
                </div>
            </div>
        </div>
    );
}
